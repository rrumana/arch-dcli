#!/bin/bash

# Check if custom theme is active
CURRENT_THEME=$(cat ~/.config/symphony/.current-theme 2>/dev/null || echo "dynamic")
if [[ "$CURRENT_THEME" != "dynamic" ]]; then
	notify-send "Theme Locked" "Switch to Dynamic first"
	exit 0
fi

# Directory containing wallpapers
WALLPAPER_DIR="$HOME/Wallpapers/"
STATE_FILE="$HOME/.current_wallpaper_index"

mapfile -t WALLPAPERS < <(find "$WALLPAPER_DIR" -type f \( -iname '*.jpg' -o -iname '*.png' \) | sort)

# Get number of wallpapers
NUM_WALLPAPERS=${#WALLPAPERS[@]}
if [ "$NUM_WALLPAPERS" -eq 0 ]; then
	(action=$(notify-send -A "open=Get Wallpapers" --wait "No Wallpapers Found" "Add images to ~/Wallpapers to use dynamic theming") && [[ "$action" == "open" ]] && xdg-open "https://github.com/vyrx-dev/Wallpapers") &
	exit 1
fi

if [ -f "$STATE_FILE" ]; then
	INDEX=$(<"$STATE_FILE")
	INDEX=$((RANDOM % NUM_WALLPAPERS))
	# INDEX=$(((INDEX + 1) % NUM_WALLPAPERS)) #cycles through wallpapers in sequence
else
	INDEX=0
fi

echo "$INDEX" >"$STATE_FILE"

CURRENT_WALLPAPER="${WALLPAPERS[$INDEX]}"

# Start swww daemon if needed
swww query &>/dev/null || swww-daemon --format xrgb

# swww img "$CURRENT_WALLPAPER" --transition-type=right --transition-fps 60 --transition-duration=1
swww img "$CURRENT_WALLPAPER" \
	--transition-type center \
	--transition-pos top-right \
	--transition-fps 120 \
	--transition-duration 1 \
	--transition-bezier 0.25,0.1,0.25,1.0

# Update wallpaper symlink to track current wallpaper
DISPLAYED_WALLPAPER=$(swww query | grep "currently displaying" | head -1 | sed 's/.*image: //')
if [ -n "$DISPLAYED_WALLPAPER" ]; then
	ln -sf "$DISPLAYED_WALLPAPER" "$HOME/.config/symphony/themes/dynamic/wallpaper"
fi

# SWWW_PARAMS="--transition-fps 60 --transition-type=any --transition-duration=1"
matugen image "$CURRENT_WALLPAPER" -m dark

# Update Symphony apps that need special handling
"$HOME/.config/symphony/install/themes/symphony" reload

# Reload apps not handled by symphony
restart-app swayosd-server

pgrep -x nautilus >/dev/null && (
	pkill -x nautilus
	nautilus &>/dev/null &
	disown
)

notify-send -i "$CURRENT_WALLPAPER" "Dynamic" "Colors from wallpaper"
