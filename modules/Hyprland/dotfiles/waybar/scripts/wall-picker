#!/bin/bash
# Wallpaper picker - swww only (no theme changes)

WALLPAPER_DIR="$HOME/Wallpapers/"
SWWW_PARAMS="--transition-fps 60 --transition-type=any --transition-duration=1"

# Get focused monitor
focused_monitor=$(hyprctl -j monitors | jq -r '.[] | select(.focused==true).name')
: "${focused_monitor:=HDMI-A-1}"

# Get wallpapers
mapfile -d '' wallpapers < <(find "$WALLPAPER_DIR" -type f \( -iname "*.jpg" -o -iname "*.jpeg" -o -iname "*.png" -o -iname "*.gif" \) -print0)

if [[ ${#wallpapers[@]} -eq 0 ]]; then
  (action=$(notify-send -A "open=Get Wallpapers" --wait "No Wallpapers Found" "Add images to ~/Wallpapers to use dynamic theming") && [[ "$action" == "open" ]] && xdg-open "https://github.com/vyrx-dev/Wallpapers") &
  exit 1
fi

# Build menu with thumbnails
menu() {
  for wallpaper in "${wallpapers[@]}"; do
    printf "%s\x00icon\x1f%s\n" "$(basename "$wallpaper")" "$wallpaper"
  done | sort
}

# Start swww if needed
swww query &>/dev/null || swww-daemon --format xrgb

# Show menu
choice=$(menu | rofi -i -dmenu -config ~/.config/rofi/custom-rofi/config-wallpaper.rasi)
[[ -z "$choice" ]] && exit 0

# Apply wallpaper
for wallpaper in "${wallpapers[@]}"; do
  [[ "$(basename "$wallpaper")" == "$choice" ]] || continue
  
  swww img -o "$focused_monitor" "$wallpaper" $SWWW_PARAMS
  notify-send -i "$wallpaper" "Wallpaper Changed" "$(basename "$wallpaper")"
  break
done
