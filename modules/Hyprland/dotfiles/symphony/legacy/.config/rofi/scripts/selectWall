#!/bin/bash
# wallpaper picker with dynamic color generation

current_theme=$(cat ~/.config/symphony/.current-theme 2>/dev/null || echo "dynamic")
if [[ "$current_theme" != "dynamic" ]]; then
	notify-send "Theme Locked" "Switch to Dynamic first"
	exit 0
fi

wallpaper_dir="$HOME/Wallpapers"
swww_params="--transition-fps 120 --transition-type grow --transition-duration 1 --transition-bezier 0.25,0.1,0.25,1.0 --transition-pos top-right"

mapfile -d '' wallpapers < <(find "$wallpaper_dir" -type f \( -iname "*.jpg" -o -iname "*.jpeg" -o -iname "*.png" -o -iname "*.gif" \) -print0)

if [[ ${#wallpapers[@]} -eq 0 ]]; then
	(action=$(notify-send -A "open=Get Wallpapers" --wait "No Wallpapers Found" "Add images to ~/Wallpapers to use dynamic theming") && [[ "$action" == "open" ]] && xdg-open "https://github.com/vyrx-dev/Wallpapers") &
	exit 1
fi

# build rofi menu with thumbnails
menu() {
	for wp in "${wallpapers[@]}"; do
		name=$(basename "$wp")
		printf "%s\x00icon\x1f%s\n" "$name" "$wp"
	done | sort
}

swww query &>/dev/null || swww-daemon --format xrgb

choice=$(menu | rofi -i -dmenu -p "" -config ~/.config/rofi/custom-rofi/config-wallpaper.rasi)
[[ -z "$choice" ]] && exit 0

# find and apply selected wallpaper
for wp in "${wallpapers[@]}"; do
	if [[ "$(basename "$wp")" == "$choice" ]]; then
		swww img "$wp" $swww_params
		matugen image "$wp" -m dark

		# update wallpaper symlink for hyprlock
		mkdir -p "$HOME/.config/symphony/current"
		ln -sf "$wp" "$HOME/.config/symphony/current/wallpaper"

		"$HOME/dotfiles/install/themes/symphony" reload
		restart-app swayosd-server

		# nautilus needs full restart to pick up new gtk theme
		pgrep -x nautilus >/dev/null && (
			pkill -x nautilus
			nautilus &>/dev/null &
		)

		notify-send -i "$wp" "Dynamic" "Colors from wallpaper"
		break
	fi
done
