#!/bin/bash
# theme picker with image previews
source "$(dirname "$0")/thumbcache"

themes_dir="$HOME/dotfiles/themes"
symphony="$HOME/dotfiles/install/themes/symphony"
current_theme=$(cat ~/.config/symphony/.current-theme 2>/dev/null || echo "dynamic")

# calculate optimal columns based on screen width
if command -v hyprctl &>/dev/null; then
    mon_width=$(hyprctl monitors -j | jq '.[0].width // 1920')
elif command -v xrandr &>/dev/null; then
    mon_width=$(xrandr | grep '\*' | head -1 | awk '{print $1}' | cut -d'x' -f1)
else
    mon_width=1920
fi

# ~200px per theme card at 80% width, cap between 3-6 columns
cols=$(( (mon_width * 80 / 100) / 200 ))
[[ $cols -lt 3 ]] && cols=3
[[ $cols -gt 6 ]] && cols=6

# get preview image: preview.png > backgrounds/* > wallpaper symlink
get_preview() {
	local dir="$1"
	[[ -f "$dir/preview.png" ]] && echo "$dir/preview.png" && return
	[[ -f "$dir/preview.jpg" ]] && echo "$dir/preview.jpg" && return

	local wall=$(find "$dir/backgrounds" -type f \( -name "*.jpg" -o -name "*.png" -o -name "*.webp" \) 2>/dev/null | sort -V | head -1)
	[[ -n "$wall" ]] && echo "$wall" && return

	[[ -L "$dir/wallpaper" ]] && readlink -f "$dir/wallpaper"
}

menu() {
	for dir in "$themes_dir"/*/; do
		name=$(basename "$dir")
		[[ "$name" == "Wallpapers" || "$name" == ".git" ]] && continue
		[[ ! -d "$dir/.config" ]] && continue

		preview=$(get_preview "$dir")
		[[ -z "$preview" ]] && continue

		printf "%s\x00icon\x1f%s\n" "$name" "$(get_thumb "$preview")"
	done | sort
}

choice=$(menu | rofi -i -dmenu -p "" \
    -theme-str "listview{columns:$cols;}" \
    -config ~/.config/rofi/custom-rofi/config-theme-picker.rasi)
[[ -z "$choice" ]] && exit 0

if [[ "$choice" == "$current_theme" ]]; then
	notify-send "Already using $choice"
	exit 0
fi

"$symphony" switch "$choice"
