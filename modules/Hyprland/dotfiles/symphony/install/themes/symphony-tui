#!/bin/bash
#|---/ /+---------------------+---/ /|#
#|--/ /-| Symphony Dotfiles   |--/ /-|#
#|-/ /--| Theme Manager TUI   |-/ /--|#
#|/ /---+---------------------+/ /---|#

set -e

SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
DOTFILES="${DOTFILES:-$HOME/.config/symphony}"
THEMES_DIR="$DOTFILES/themes"
BRANDING="$DOTFILES/branding"
API="https://omarchythemes.com/api/themes/all"

C_ACCENT="\033[38;5;218m"
C_DIM="\033[38;5;245m"
C_OK="\033[38;5;215m"
C_ERR="\033[38;5;203m"
C_RESET="\033[0m"

command -v gum &>/dev/null || { echo "need gum"; exit 1; }

# Set a stable window title for Hyprland rules.
case "${1:-}" in
    --browse-inner) printf '\033]0;symphony-browse\007' ;;
    *) printf '\033]0;symphony-tui\007' ;;
esac

# gum choose wrappers with consistent styling
choose() {
    gum choose --cursor="› " --show-help "$@"
}

choose_multi() {
    local header="${1:-Select items}"
    shift
    gum choose --no-limit \
        --cursor="› " \
        --cursor-prefix="○ " \
        --selected-prefix="● " \
        --unselected-prefix="○ " \
        --header "$header (x toggle • ←↓↑→ navigate • enter submit • ctrl+a select all)" \
        "$@"
}

# ╭───────────────────────────────────────────────────────────────────────╮
# │ Browse Omarchy Themes                                                 │
# ╰───────────────────────────────────────────────────────────────────────╯

browse_inner() {
    local data
    data=$(curl -sL "$API") || { echo -e "${C_ERR}fetch failed${C_RESET}"; sleep 2; return 1; }
    
    local preview_script
    preview_script=$(mktemp)
    trap "rm -f '$preview_script'" RETURN
    
    cat > "$preview_script" <<'EOF'
#!/bin/bash
[[ -z "$1" || "$1" == "null" ]] && exit 0
command -v chafa &>/dev/null && curl -sL "$1" 2>/dev/null | chafa -s "${FZF_PREVIEW_COLUMNS:-60}x${FZF_PREVIEW_LINES:-30}" -
EOF
    chmod +x "$preview_script"
    
    local sel
    sel=$(echo "$data" | jq -r '.[] | select(.url | startswith("https://github.com")) | [.name, .url, .preview_img] | @tsv' | sort | \
        fzf --delimiter=$'\t' --with-nth=1 \
            --preview="$preview_script {3}" \
            --preview-window=right:50% \
            --prompt="› " --pointer="›" \
            --layout=reverse) || return 0
    
    [[ -z "$sel" ]] && return 0
    
    local url
    url=$(cut -f2 <<< "$sel")
    
    echo ""
    "$SCRIPT_DIR/symphony-import/import.sh" "$url" && echo -e "${C_OK}done${C_RESET}" || echo -e "${C_ERR}failed${C_RESET}"
    sleep 2
}

browse() { ghostty --title symphony-browse -e "$0" --browse-inner 2>/dev/null; }

# ╭───────────────────────────────────────────────────────────────────────╮
# │ Delete Themes                                                         │
# ╰───────────────────────────────────────────────────────────────────────╯

delete_themes() {
    local themes=()
    
    for d in "$THEMES_DIR"/*/; do
        local t=$(basename "$d")
        [[ "$t" != "Wallpapers" && "$t" != "dynamic" ]] && themes+=("$t")
    done
    
    [[ ${#themes[@]} -eq 0 ]] && { echo -e "${C_ERR}no themes to delete${C_RESET}"; sleep 1; return; }
    
    mapfile -t themes < <(printf '%s\n' "${themes[@]}" | sort)
    
    local result
    result=$(printf '%s\n' "${themes[@]}" | choose_multi "Select themes to delete" --height=15) || return
    [[ -z "$result" ]] && return
    
    echo -e "\n${C_DIM}deleting:${C_RESET}"
    while IFS= read -r theme; do
        echo -e "  ${C_ERR}$theme${C_RESET}"
    done <<< "$result"
    echo ""
    
    gum confirm "confirm?" || return
    
    while IFS= read -r theme; do
        "$SCRIPT_DIR/symphony" remove "$theme" <<< "y" 2>/dev/null
    done <<< "$result"
    echo -e "${C_OK}done${C_RESET}"
    sleep 1
}

# ╭───────────────────────────────────────────────────────────────────────╮
# │ Import Theme                                                          │
# ╰───────────────────────────────────────────────────────────────────────╯

import_url() {
    echo -e "${C_DIM}e.g. https://github.com/bjarneo/omarchy-sakura-theme${C_RESET}"
    echo ""
    
    local url
    url=$(gum input --placeholder "user/repo or github url" --width=50)
    [[ -z "$url" ]] && return
    echo ""
    
    "$SCRIPT_DIR/symphony-import/import.sh" "$url" && echo -e "${C_OK}done${C_RESET}" || echo -e "${C_ERR}failed${C_RESET}"
    sleep 2
}

omarchy_menu() {
    clear
    gum style --bold --foreground 212 "♪ omarchy themes"
    echo ""
    
    local choice
    choice=$(choose "Browse" "Import" "Back")
    
    case "$choice" in
        "Browse") browse ;;
        "Import") import_url ;;
        *)        return ;;
    esac
}

# ╭───────────────────────────────────────────────────────────────────────╮
# │ Web Apps                                                              │
# ╰───────────────────────────────────────────────────────────────────────╯

WEBAPP_DIR="$HOME/.config/hypr/scripts"

webapp_menu() {
    clear
    gum style --bold --foreground 212 "♪ web apps"
    echo ""
    
    local choice
    choice=$(choose "Install" "Remove" "Back")
    
    case "$choice" in
        "Install") "$WEBAPP_DIR/webapp-install"; sleep 1; webapp_menu ;;
        "Remove")  "$WEBAPP_DIR/webapp-remove"; sleep 1; webapp_menu ;;
        *)         return ;;
    esac
}

# ╭───────────────────────────────────────────────────────────────────────╮
# │ Main Menu                                                             │
# ╰───────────────────────────────────────────────────────────────────────╯

show_banner() {
    [[ ! -f "$BRANDING/symphony.txt" ]] && return
    
    local cols=$(tput cols)
    local pad=$(( (cols - 55) / 2 ))
    [[ $pad -lt 0 ]] && pad=0
    local padding=$(printf '%*s' "$pad" '')
    
    if command -v tte &>/dev/null; then
        sed "s/^/$padding/" "$BRANDING/symphony.txt" | tte \
            --frame-rate 120 expand \
            --movement-speed 0.5 \
            --expand-easing IN_OUT_QUART \
            --final-gradient-stops FFEB3B FFB74D FF8A80 F48FB1 EC407A \
            --final-gradient-steps 12 \
            --final-gradient-frames 3 \
            --final-gradient-direction vertical 2>/dev/null && return
    fi
    
    echo -e "${C_ACCENT}"
    sed "s/^/$padding/" "$BRANDING/symphony.txt"
    echo -e "${C_RESET}"
}

main() {
    clear
    echo ""
    show_banner
    echo ""
    
    local choice
    choice=$(choose "Web Apps" "Choose Shell" "Omarchy Themes" "Delete Themes" "Exit")
    
    case "$choice" in
        "Omarchy Themes") omarchy_menu; main ;;
        "Web Apps")       webapp_menu; main ;;
        "Choose Shell")   "$DOTFILES/scripts/choose-shell"; main ;;
        "Delete Themes")  delete_themes; main ;;
        *)                clear; exit 0 ;;
    esac
}

[[ "$1" == "--browse-inner" ]] && { browse_inner; exit 0; }
main
